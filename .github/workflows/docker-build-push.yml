# Generated by cue/workflows_tool.cue; do not edit
name: Build, push and deploy the Docker image
"on":
  push:
    branches:
      - main
    paths:
      - '**.go'
      - go.mod
      - go.sum
  workflow_dispatch: {}
jobs:
  build:
    name: Build, push and deploy the Docker image
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b
      - name: Login to Docker Hub
        uses: docker/login-action@49ed152c8eca782a232dede0303416e8f356c37b
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@67fbcbb121271f7775d2e7715933280b06314838
        with:
          aws-region: eu-north-1
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      - id: ecr-login
        name: Login to ECR using OIDC
        uses: aws-actions/amazon-ecr-login@9149ade017c57f86dea2f76a01f8b2d5bd06b10f
      - id: docker-meta
        name: Extract metadata (tags, labels) from Git reference and GitHub events
        uses: docker/metadata-action@69f6fc9d46f2f8bf0d5491e4aabe0bb8c6a4678a
        with:
          images: |-
            staticaland/snippetbox
            ${{ steps.ecr-login.outputs.registry }}/machinarium
          tags: |-
            type=sha,format=long
            type=sha,prefix=
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@dc7b9719a96d48369863986a06765841d7ea23f6
      - name: Build and push (if enabled) Docker image to Docker Hub and AWS
        uses: docker/build-push-action@c84f38281176d4c9cdb1626ffafcd6b3911b5d94
        with:
          context: .
          file: Dockerfile.multistage
          load: true
          push: false
          tags: ${{ steps.docker-meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Run the Docker image
        run: docker run --rm ${{ fromJSON(steps.docker-meta.outputs.json).tags[0] }}
      - name: Setup CUE environment
        uses: cue-lang/setup-cue@143c2fe537047bf8c7ead6a30784ad1802e9d991
        with:
          version: v0.4.3
      - if: '{{ false }}'
        name: Render task definition using CUE
        run: |-
          cue export cue/ecs/ecs_task_def.cue \
          	   --inject app_image='${{ fromJSON(steps.docker-meta.outputs.json).tags[2] }}' \
          	   --inject ecs_execution_role_arn='ecsTaskExecutionRole' \
          	   --expression ecs_task_def \
          	   > task-definition.json
      - if: '{{ false }}'
        name: Register a ECS task definition and deploy it to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@9c18d81893224634ac107b91720119c91c1d600e
        with:
          task-definition: task-definition.json
          service: snippetbox
          cluster: ecs-fargate
          wait-for-service-stability: true
permissions:
  contents: read
